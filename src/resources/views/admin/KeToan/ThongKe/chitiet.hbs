<div class="container py-5">
    <a href="/admin/thongke" class="btn btn-secondary mb-3">← Quay lại</a>

    <h2 class="fw-bold mb-4">Chi tiết khoản phí căn hộ {{idCanHo}} - Tháng {{thang}}/{{nam}}</h2>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Tên khoản phí</th>
                    <th>Số tiền</th>
                    <th>Trạng thái</th>
                    <th>Mô tả</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                {{#each danhSachPhi}}
                <tr>
                    <td>{{@index}}</td>
                    <td>{{this.loaiPhi}}</td>
                    <td>{{this.soTien}} VND</td>
                    <td>
                        <span class="badge {{#if this.daDong}}bg-success{{else}}bg-warning{{/if}}">
                            {{#if this.daDong}}Đã đóng{{else}}Chưa đóng{{/if}}
                        </span>
                    </td>
                    <td>{{this.moTa}}</td>
                    <td>
                        {{#unless this.daDong}}
                        <button class="btn btn-sm btn-success btn-dong-tien"
                            data-link="/admin/thongke/{{../idCanHo}}/dongtien/{{this._id}}?thang={{../thang}}&nam={{../nam}}"
                            data-ten="{{this.loaiPhi}}" data-thang="{{../thang}}" data-nam="{{../nam}}"
                            data-sotien="{{this.soTien}}" data-idcanho="{{../idCanHo}}">
                            Đóng tiền
                        </button>
                        {{else}}
                        <span class="text-muted">Đã đóng</span>
                        {{/unless}}
                    </td>

                </tr>
                {{else}}
                <tr>
                    <td colspan="6" class="text-center">Không có khoản phí nào.</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Xác nhận -->
<div class="modal fade" id="xacNhanDongTienModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Xác nhận đóng tiền</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p id="modal-noi-dung" class="mb-2"></p>
                <ul class="list-unstyled">
                    <li><strong>ID Căn hộ:</strong> <span id="modal-id-can-ho"></span></li>
                    <li><strong>Tên khoản phí:</strong> <span id="modal-ten-khoan-phi"></span></li>
                    <li><strong>Số tiền:</strong> <span id="modal-so-tien"></span> VND</li>
                    <li><strong>Tháng/Năm:</strong> <span id="modal-thang-nam"></span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <a href="#" id="modal-xac-nhan-link" class="btn btn-success">Xác nhận đóng tiền</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.btn-dong-tien');
        const modal = new bootstrap.Modal(document.getElementById('xacNhanDongTienModal'));
        const modalNoiDung = document.getElementById('modal-noi-dung');
        const modalIdCanHo = document.getElementById('modal-id-can-ho');
        const modalTenKhoanPhi = document.getElementById('modal-ten-khoan-phi');
        const modalSoTien = document.getElementById('modal-so-tien');
        const modalThangNam = document.getElementById('modal-thang-nam');
        const modalXacNhanLink = document.getElementById('modal-xac-nhan-link');

        let currentButton = null;

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const ten = btn.getAttribute('data-ten');
                const thang = btn.getAttribute('data-thang');
                const nam = btn.getAttribute('data-nam');
                const soTien = btn.getAttribute('data-sotien');
                const idCanHo = btn.getAttribute('data-idcanho');
                const link = btn.getAttribute('data-link');

                modalNoiDung.textContent = `Bạn chắc chắn muốn đóng tiền khoản phí "${ten}" cho căn hộ ${idCanHo} tháng ${thang}/${nam}?`;
                modalIdCanHo.textContent = idCanHo;
                modalTenKhoanPhi.textContent = ten;
                modalSoTien.textContent = soTien;
                modalThangNam.textContent = `${thang}/${nam}`;
                modalXacNhanLink.href = link;

                currentButton = btn;
                modal.show();
            });
        });

        modalXacNhanLink.addEventListener('click', e => {
            e.preventDefault();
            const url = modalXacNhanLink.href;

            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        modal.hide();
                        if (currentButton) {
                            const td = currentButton.parentElement;
                            td.innerHTML = '<span class="text-muted">Đã đóng</span>';
                            const badge = td.parentElement.querySelector('span.badge');
                            badge.classList.remove('bg-warning');
                            badge.classList.add('bg-success');
                            badge.textContent = 'Đã đóng';
                        }
                    } else {
                        alert('Có lỗi xảy ra: ' + data.message);
                    }
                })
                .catch(err => alert('Lỗi kết nối: ' + err.message));
        });
    });
</script>