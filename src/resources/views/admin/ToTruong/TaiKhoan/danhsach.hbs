  <h2>Danh sÃ¡ch tÃ i khoáº£n</h2>

  <form class="form-filter" onsubmit="return false;">
    <div class="form-group">
      <label>Há» tÃªn</label>
      <input type="text" id="filterHoTen" placeholder="Nháº­p há» tÃªn">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="text" id="filterEmail" placeholder="Nháº­p email">
    </div>
    <div class="button-group">
      <button type="button" class="btn btn-filter" onclick="filterTable()">ğŸ” Lá»c</button>
      <button type="button" class="btn btn-reset" onclick="resetFilter()">LÃ m má»›i</button>
      <a href="/admin/taikhoan/add" class="btn btn-add">+ ThÃªm má»›i</a>
    </div>
  </form>

  <table class="table-nhankhau">
    <thead>
      <tr>
        <th>ID</th>
        <th>TÃªn Ä‘Äƒng nháº­p</th>
        <th>Há» tÃªn</th>
        <th>Email</th>
        <th>Vai trÃ²</th>
        <th>XÃ³a</th>
      </tr>
    </thead>
    <tbody>
      {{#each taikhoans}}
        <tr>
          <td>{{this.idTaiKhoan}}</td>
          <td>{{this.tenDangNhap}}</td>
          <td>{{this.hoTen}}</td>
          <td>{{this.email}}</td>
          <td>
            <select name="role" data-id="{{this.idTaiKhoan}}">
              <option value="admin" {{#if (eq this.role 'admin')}}selected{{/if}}>admin</option>
              <option value="user" {{#if (eq this.role 'user')}}selected{{/if}}>user</option>
            </select>
          </td>
          <td>
            <form action="/admin/taikhoan/{{this.idTaiKhoan}}" method="POST" onsubmit="return confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a tÃ i khoáº£n nÃ y khÃ´ng?');">
              <button type="submit" class="btn btn-delete">âŒ</button>
            </form>
          </td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  <div id="saveChangesContainer" style="display: none; text-align: right; margin-top: 16px;">
    <form id="saveChangesForm" action="/admin/taikhoan" method="POST">
      <input type="hidden" name="updatedRoles" id="updatedRoles">
      <button type="submit" class="btn btn-save">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
    </form>
  </div>

  <script>
    const originalRoles = {};

    document.querySelectorAll('select[name="role"]').forEach(select => {
      const id = select.dataset.id;
      originalRoles[id] = select.value;

      select.addEventListener('change', () => {
        checkForChanges();
      });
    });

    function checkForChanges() {
      let hasChanges = false;
      const updates = [];

      document.querySelectorAll('select[name="role"]').forEach(select => {
        const id = select.dataset.id;
        const currentValue = select.value;
        const originalValue = originalRoles[id];

        if (currentValue !== originalValue) {
          hasChanges = true;
          updates.push({ idTaiKhoan: parseInt(id), role: currentValue });
        }
      });

      const container = document.getElementById('saveChangesContainer');
      container.style.display = hasChanges ? 'block' : 'none';

      const form = document.getElementById('saveChangesForm');
      form.onsubmit = function (e) {
        e.preventDefault(); // NgÄƒn submit máº·c Ä‘á»‹nh
        fetch('/admin/taikhoan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ updates })  // ğŸ‘ˆ TrÃ¹ng vá»›i req.body.updates
        })
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              alert('LÆ°u tháº¥t báº¡i!');
            }
          })
          .catch(err => {
            console.error(err);
            alert('Lá»—i khi gá»­i yÃªu cáº§u.');
          });
      };
    }
  </script>


